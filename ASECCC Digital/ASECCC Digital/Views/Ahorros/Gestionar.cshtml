@model IEnumerable<ASECCC_Digital.Models.AhorroViewModel>

@{
    Layout = "_LayoutInterno";
    ViewData["Title"] = "Gestionar Ahorros";

    var qNombre = Context.Request.Query["nombreAsociado"].ToString();
    var qTipo = Context.Request.Query["tipoAhorroId"].ToString();
    var qEstado = Context.Request.Query["estado"].ToString();
}

<div class="row">
    <div class="col-md-12">

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">Gestionar Ahorros</h5>
            </div>

            <div class="card-body">

                <form method="get" class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Nombre del Asociado</label>
                        <input type="text"
                               class="form-control"
                               name="nombreAsociado"
                               value="@qNombre"
                               placeholder="Buscar por nombre" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Tipo de ahorro</label>
                        <select class="form-select" name="tipoAhorroId">
                            <option value="">Todos</option>

                            @if (qTipo == "1")
                            {
                                <option value="1" selected>A la Vista</option>
                            }
                            else
                            {
                                <option value="1">A la Vista</option>
                            }

                            @if (qTipo == "2")
                            {
                                <option value="2" selected>Navideno</option>
                            }
                            else
                            {
                                <option value="2">Navideno</option>
                            }

                            @if (qTipo == "3")
                            {
                                <option value="3" selected>Marchamo</option>
                            }
                            else
                            {
                                <option value="3">Marchamo</option>
                            }

                            @if (qTipo == "4")
                            {
                                <option value="4" selected>Escolar</option>
                            }
                            else
                            {
                                <option value="4">Escolar</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Estado</label>
                        <select class="form-select" name="estado">
                            <option value="">Todos</option>

                            @if (qEstado == "Activo")
                            {
                                <option value="Activo" selected>Activo</option>
                            }
                            else
                            {
                                <option value="Activo">Activo</option>
                            }

                            @if (qEstado == "Finalizado")
                            {
                                <option value="Finalizado" selected>Finalizado</option>
                            }
                            else
                            {
                                <option value="Finalizado">Finalizado</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="ti ti-search"></i> Buscar
                        </button>
                    </div>
                </form>

                <div class="table-responsive mt-3">
                    <table class="table table-striped align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Asociado</th>
                                <th>Tipo</th>
                                <th>Monto Inicial</th>
                                <th>Monto Actual</th>
                                <th>Estado</th>
                                <th style="width: 340px;">Acciones</th>
                            </tr>
                        </thead>

                        <tbody>
                            @if (Model != null && Model.Any())
                            {
                                foreach (var ahorro in Model)
                                {
                                    var badge = ahorro.Estado == "Activo" ? "bg-success" : "bg-secondary";

                                    <tr data-id="@ahorro.AhorroId">
                                        <td>@ahorro.NombreAsociado</td>
                                        <td>@ahorro.TipoAhorro</td>
                                        <td>₡@ahorro.MontoInicial.ToString("N2")</td>
                                        <td>₡@ahorro.MontoActual.ToString("N2")</td>
                                        <td><span class="badge @badge">@ahorro.Estado</span></td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1"
                                                    onclick="verDetalle(@ahorro.AhorroId)">
                                                Detalles
                                            </button>

                                            <button type="button" class="btn btn-sm btn-outline-secondary me-1"
                                                    onclick="verHistorial(@ahorro.AhorroId)">
                                                Historial
                                            </button>

                                            @if (ahorro.Estado == "Activo")
                                            {
                                                <button type="button" class="btn btn-sm btn-outline-warning me-1"
                                                        onclick="modificarMonto(@ahorro.AhorroId)">
                                                    Modificar
                                                </button>

                                                <button type="button" class="btn btn-sm btn-outline-danger"
                                                        onclick="eliminarAhorro(@ahorro.AhorroId)">
                                                    Eliminar
                                                </button>
                                            }
                                            else
                                            {
                                                <button type="button" class="btn btn-sm btn-outline-secondary me-1" disabled>Modificar</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" disabled>Eliminar</button>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No hay registros</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (ViewBag.Error != null)
                {
                    <div class="alert alert-danger mt-3">@ViewBag.Error</div>
                }

            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        function asegurarLibs() {
            if (typeof $ === "undefined") { alert("jQuery no cargo. Revisa _LayoutInterno."); return false; }
            if (typeof Swal === "undefined") { alert("SweetAlert2 no cargo"); return false; }
            return true;
        }

        function verDetalle(idAhorro) {
            if (!asegurarLibs()) return;

            $.get('@Url.Action("Detalle", "Ahorros")', { ahorroId: idAhorro })
                .done(function (html) {
                    Swal.fire({ title: 'Detalle de Ahorro', html: html, width: 600 });
                })
                .fail(function () {
                    Swal.fire('Error', 'No se pudo cargar el detalle', 'error');
                });
        }

        function verHistorial(idAhorro) {
            if (!asegurarLibs()) return;

            $.get('@Url.Action("Historial", "Ahorros")', { ahorroId: idAhorro })
                .done(function (html) {
                    Swal.fire({ title: 'Historial de Transacciones', html: html, width: 900 });
                })
                .fail(function () {
                    Swal.fire('Error', 'No se pudo cargar el historial', 'error');
                });
        }

        function modificarMonto(idAhorro) {
            if (!asegurarLibs()) return;

            Swal.fire({
                title: 'Modificar Monto Inicial',
                input: 'number',
                inputLabel: 'Nuevo monto inicial',
                inputAttributes: { min: 0, step: 0.01 },
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (!result.isConfirmed || !result.value) return;

                $.post('@Url.Action("ModificarMonto", "Ahorros")',
                    { ahorroId: idAhorro, nuevoMonto: result.value }
                )
                .done(function (resp) {
                    if (resp && resp.exito) {
                        Swal.fire('Guardado', 'El monto fue actualizado', 'success')
                            .then(() => location.reload());
                    } else {
                        Swal.fire('Error', 'No se pudo actualizar el monto', 'error');
                    }
                })
                .fail(function () {
                    Swal.fire('Error', 'No se pudo actualizar el monto', 'error');
                });
            });
        }

        function eliminarAhorro(idAhorro) {
            if (!asegurarLibs()) return;

            Swal.fire({
                title: 'Eliminar ahorro?',
                text: 'Esta accion no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Si, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (!result.isConfirmed) return;

                $.post('@Url.Action("Eliminar", "Ahorros")', { ahorroId: idAhorro })
                    .done(function (resp) {
                        if (resp && resp.exito) {
                            Swal.fire('Eliminado', 'El ahorro fue eliminado', 'success')
                                .then(() => location.reload());
                        } else {
                            Swal.fire('Error', 'No se pudo eliminar el ahorro', 'error');
                        }
                    })
                    .fail(function () {
                        Swal.fire('Error', 'No se pudo eliminar el ahorro', 'error');
                    });
            });
        }
    </script>
}
